---
type: v1/system

node_pools:
  main:
    instance_type: t2.small
    num_instances: 2

components:
  api:
    type: v1/service
    description: Backend API for Petflix app

    ports:
      "80":
        protocol: HTTP
        external_access:
          public: true


    build:
      type: command_build
      source:
        git_repository:
          url: "git@github.com:mlab-lattice/api-services.git"
          branch: "master"
          ssh_key: "/:git-ssh-key"
      base_image:
        repository: library/node
        tag: carbon
      command:
      - "ls -al && cd private && npm install"

    exec:
      command:
      - node
      - private/lib/index.js
      environment:
        LATTICE_CORE_DB_URI: {"$secret_ref": "/:core-db-uri"}
        LATTICE_AUDIT_DB_URI: {"$secret_ref": "/:audit-db-uri"}
        LATTICE_PAGERDUTY_ROUTING_KEY: {"$secret_ref": "/:pagerduty-routing-key"}
        LATTICE_SENDGRID_API_KEY: {"$secret_ref": "sendgrid-api-key"}
        LATTICE_EXTERNAL_ADDRESS: "https://staging.lattice.mlab.com"
